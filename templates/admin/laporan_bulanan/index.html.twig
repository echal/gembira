{% extends 'admin/_layout.html.twig' %}

{% block title %}Laporan Bulanan Kehadiran - Admin Gembira{% endblock %}

{% block page_icon %}📈{% endblock %}
{% block page_title %}Laporan Bulanan Kehadiran{% endblock %}
{% block page_description %}Laporan kehadiran per bulan{{ app.user.isSuperAdmin() ? '' : ' (Unit Saya)' }}{% endblock %}

{% block header_actions %}
    <button onclick="refreshData()"
            class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-medium text-sm">
        <span class="mr-2">🔄</span> Refresh
    </button>
{% endblock %}

{% block admin_content %}

            <!-- Action Buttons -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex space-x-3">
                    <select id="tahunFilter" onchange="updateBulanOptions()"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Pilih Tahun</option>
                        {% for i in range(2023, 2030) %}
                            <option value="{{ i }}" {{ app.request.query.get('tahun') == (i ~ '') ? 'selected' : '' }}>{{ i }}</option>
                        {% endfor %}
                    </select>

                    <select id="bulanFilter"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Pilih Bulan</option>
                        {% for key, value in {
                            '01': 'Januari', '02': 'Februari', '03': 'Maret', '04': 'April',
                            '05': 'Mei', '06': 'Juni', '07': 'Juli', '08': 'Agustus',
                            '09': 'September', '10': 'Oktober', '11': 'November', '12': 'Desember'
                        } %}
                            <option value="{{ key }}" {{ app.request.query.get('bulan') == key ? 'selected' : '' }}>{{ value }}</option>
                        {% endfor %}
                    </select>

                    {% if not app.user.isSuperAdmin() %}
                        <!-- Admin Unit hanya lihat unit kerjanya -->
                        <input type="hidden" id="unitKerjaFilter" value="{{ app.user.unitKerjaEntity.id }}">
                        <div class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg border border-purple-300">
                            📍 {{ app.user.unitKerjaEntity.namaUnit }}
                        </div>
                    {% else %}
                        <!-- Super Admin bisa pilih semua unit kerja -->
                        <select id="unitKerjaFilter"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Semua Unit Kerja</option>
                            {% for unit in unit_kerja_list %}
                                <option value="{{ unit.id }}" {{ app.request.query.get('unit_kerja') == (unit.id ~ '') ? 'selected' : '' }}>{{ unit.namaUnit }}</option>
                            {% endfor %}
                        </select>
                    {% endif %}

                    <button onclick="filterData()"
                            class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg font-medium">
                        <span class="mr-2">🔍</span> Filter
                    </button>
                </div>
            </div>

            <!-- Filter & Export Section -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <span class="mr-2">🔍</span> Filter Data & Export Laporan
                    </h3>
                </div>

                <!-- Export Options -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-medium text-gray-700 mb-3">📊 Export Laporan Bulanan (Format Kanwil)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tahun</label>
                            <select id="exportTahun" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                {% for i in range(2023, 2030) %}
                                    <option value="{{ i }}" {{ i == 2025 ? 'selected' : '' }}>{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bulan</label>
                            <select id="exportBulan" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="September" selected>September</option>
                                <option value="Oktober">Oktober</option>
                                <option value="November">November</option>
                                <option value="Desember">Desember</option>
                                <option value="Januari">Januari</option>
                                <option value="Februari">Februari</option>
                                <option value="Maret">Maret</option>
                                <option value="April">April</option>
                                <option value="Mei">Mei</option>
                                <option value="Juni">Juni</option>
                                <option value="Juli">Juli</option>
                                <option value="Agustus">Agustus</option>
                            </select>
                        </div>
                        {% if app.user.isSuperAdmin() %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Unit Kerja</label>
                            <select id="exportUnitKerja" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Pilih Unit Kerja</option>
                                {% for unit in unit_kerja_list %}
                                    <option value="{{ unit.id }}">{{ unit.namaUnit }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                    </div>

                    <div class="mt-4">
                        <div class="text-sm text-blue-600 mb-3">
                            📋 <strong>Format Laporan:</strong> Header Kanwil Kemenag Sulbar + Tabel dengan persentase (berwarna sesuai persentase)
                        </div>

                        <div class="flex items-center space-x-3">
                            <button onclick="exportLaporan('csv')"
                                    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium text-sm">
                                📊 Export Excel (CSV)
                            </button>
                            <button onclick="exportLaporan('pdf')"
                                    class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium text-sm">
                                📋 Export PDF
                            </button>
                        </div>

                        <div class="mt-3 text-xs text-gray-600">
                            💡 <strong>Cara Download:</strong>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li><strong>Excel (CSV)</strong> → File CSV dengan data lengkap kehadiran (bisa dibuka di Excel/LibreOffice)</li>
                                <li><strong>PDF</strong> → File HTML yang siap print atau save as PDF dengan format resmi Kanwil</li>
                                <li><strong>Data konsisten</strong> → Perhitungan sama dengan laporan kehadiran (berdasarkan absen tercatat)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Display -->
            <div id="dataContainer" class="bg-white rounded-lg shadow-sm border">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">📋 Data Laporan Bulanan</h3>
                </div>

                <div class="p-6 text-center text-gray-500">
                    <div class="text-gray-400 text-5xl mb-4">📊</div>
                    <p class="text-lg">Pilih tahun dan bulan untuk melihat laporan</p>
                    <p class="text-sm mt-2">Data akan ditampilkan setelah filter dipilih</p>
                </div>
            </div>

{% endblock %}

{% block admin_javascripts %}
<script>
function filterData() {
    const tahun = document.getElementById('tahunFilter').value;
    const bulan = document.getElementById('bulanFilter').value;
    const unitKerja = document.getElementById('unitKerjaFilter').value;

    if (!tahun || !bulan) {
        showToast('Mohon pilih tahun dan bulan', 'error');
        return;
    }

    // Build URL with parameters - SESUAI FORMAT CONTROLLER BARU
    const params = new URLSearchParams();
    params.append('tahun', tahun);
    params.append('bulan', bulan);
    if (unitKerja) {
        params.append('unit_kerja', unitKerja);
    }

    // Redirect with parameters
    window.location.href = `{{ path('app_admin_laporan_bulanan') }}?${params.toString()}`;
}

function refreshData() {
    window.location.reload();
}

function updateBulanOptions() {
    // This function can be used to update month options based on year if needed
    // Currently just a placeholder
}

function exportLaporan(format = 'csv') {
    const tahun = document.getElementById('exportTahun').value;
    const bulanNama = document.getElementById('exportBulan').value; // Nama bulan (September, Oktober, etc.)
    {% if app.user.isSuperAdmin() %}
    const unitKerja = document.getElementById('exportUnitKerja').value;

    if (!unitKerja) {
        showToast('Mohon pilih unit kerja untuk export', 'error');
        return;
    }
    {% else %}
    const unitKerja = {{ app.user.unitKerjaEntity.id }};
    {% endif %}

    if (!tahun || !bulanNama) {
        showToast('Mohon pilih tahun dan bulan', 'error');
        return;
    }

    // Convert nama bulan ke number format
    const bulanMap = {
        'Januari': '01', 'Februari': '02', 'Maret': '03', 'April': '04',
        'Mei': '05', 'Juni': '06', 'Juli': '07', 'Agustus': '08',
        'September': '09', 'Oktober': '10', 'November': '11', 'Desember': '12'
    };
    const bulan = bulanMap[bulanNama];

    // Build export URL - PERBAIKAN: Support multiple formats
    const params = new URLSearchParams();
    params.append('tahun', tahun);
    params.append('bulan', bulan);
    params.append('unit_kerja', unitKerja);
    params.append('export', format);

    // Open export in new window
    window.open(`{{ path('app_admin_laporan_bulanan') }}?${params.toString()}`, '_blank');

    const formatText = format === 'pdf' ? 'PDF' : 'Excel';
    showToast(`Export laporan ${formatText} dimulai...`, 'success');
}

// Toast notification function
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white font-medium ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Auto-filter if parameters exist
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const tahun = urlParams.get('tahun');
    const bulan = urlParams.get('bulan');

    if (tahun && bulan) {
        // Set dropdown values berdasarkan URL parameters
        document.getElementById('tahunFilter').value = tahun;
        document.getElementById('bulanFilter').value = bulan;

        const unitKerja = urlParams.get('unit_kerja');
        if (unitKerja && document.getElementById('unitKerjaFilter')) {
            document.getElementById('unitKerjaFilter').value = unitKerja;
        }
    }
});
</script>
{% endblock %}