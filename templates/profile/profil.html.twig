{% extends 'base.html.twig' %}

{% block title %}Profil Saya - Gembira{% endblock %}

{% block body %}
<!-- User Header Component -->
{% include 'components/user_header.html.twig' with {
    'show_back_button': true,
    'back_url': path('app_dashboard'),
    'title': 'Profil Saya',
    'subtitle': 'Kelola informasi pribadi Anda',
    'show_welcome': false
} %}

<!-- Main Content -->
<div class="bg-gradient-to-b from-sky-50 to-sky-100 min-h-screen pb-20">
    <div class="container mx-auto px-4 py-6">

        <!-- Alert Container -->
        <div id="alertContainer" class="mb-4 hidden">
            <div id="alertMessage" class="p-4 rounded-lg shadow-sm border"></div>
        </div>

        <!-- Profil Card -->
        <div class="bg-white rounded-xl shadow-sm border border-sky-200 overflow-hidden">
            <!-- Header Card -->
            <div class="bg-gradient-to-r from-sky-500 to-sky-600 px-6 py-4">
                <div class="flex items-center space-x-4">
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <div class="text-2xl">üë§</div>
                    </div>
                    <div class="text-white">
                        <h2 class="text-xl font-bold">{{ pegawai.nama }}</h2>
                        <p class="text-sky-100 text-sm">{{ pegawai.jabatan }}</p>
                    </div>
                </div>
            </div>

            <!-- Content Card -->
            <div class="p-6">
                <!-- Upload Foto Profil Section -->
                <div class="mb-8 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 border border-blue-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">üì∏</span>
                        Foto Profil
                    </h3>

                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <!-- Preview Foto -->
                        <div class="flex-shrink-0">
                            <div id="photoPreview" class="relative">
                                {% if pegawai.photo %}
                                <img src="/uploads/photos/{{ pegawai.photo }}"
                                     alt="Foto Profil"
                                     class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg">
                                {% else %}
                                <div class="w-32 h-32 rounded-full bg-gradient-to-br from-blue-400 to-cyan-400 flex items-center justify-center text-white text-5xl border-4 border-white shadow-lg">
                                    üë§
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Upload Form -->
                        <div class="flex-1 w-full">
                            <form id="uploadPhotoForm" class="space-y-4">
                                <div>
                                    <label for="photoInput" class="block text-sm font-medium text-gray-700 mb-2">
                                        Pilih Foto Baru
                                    </label>
                                    <input type="file"
                                           id="photoInput"
                                           name="photo"
                                           accept="image/jpeg,image/jpg,image/png"
                                           class="block w-full text-sm text-gray-500
                                                  file:mr-4 file:py-2 file:px-4
                                                  file:rounded-lg file:border-0
                                                  file:text-sm file:font-semibold
                                                  file:bg-blue-50 file:text-blue-700
                                                  hover:file:bg-blue-100
                                                  cursor-pointer">
                                    <p class="mt-2 text-xs text-gray-500">
                                        Format: JPG, JPEG, PNG | Maksimal: <span class="font-semibold text-red-600">100 KB</span>
                                    </p>
                                    <p id="fileSizeInfo" class="mt-1 text-xs hidden"></p>
                                </div>

                                <button type="submit"
                                        id="uploadPhotoBtn"
                                        class="bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white px-6 py-2 rounded-lg font-medium shadow-md hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span id="uploadBtnText">üì§ Upload Foto</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- XP Progression Section (New System) -->
                <div class="mb-8 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 border border-indigo-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">‚ö°</span>
                        Level & XP Progression
                    </h3>

                    <!-- Current XP & Level Badge -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="text-center flex-1">
                            <div class="text-sm text-gray-600 mb-2">Total XP</div>
                            <div class="text-4xl font-bold text-indigo-600">
                                {{ pegawai.totalXp|format_xp }}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Experience Points</div>
                        </div>

                        <div class="text-center flex-1">
                            <div class="text-6xl mb-2">{{ pegawai.currentBadge }}</div>
                            <div class="text-sm font-bold text-gray-800">Level {{ pegawai.currentLevel }}</div>
                            <div class="text-xs text-gray-600">{{ pegawai.levelTitle }}</div>
                        </div>

                        <div class="text-center flex-1">
                            <div class="text-sm text-gray-600 mb-2">Bulan Ini</div>
                            <div class="text-4xl font-bold text-purple-600">
                                {% if userXpRank %}
                                    {{ userXpRank.xp }}
                                {% else %}
                                    0
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                {% if userXpRank %}
                                    Peringkat #{{ userXpRank.rank }}
                                {% else %}
                                    Belum ada XP
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- XP Progress Bar to Next Level -->
                    {% set xpProgress = pegawai.xpProgress %}
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Progress ke Level {{ xpProgress.next_level }}</span>
                            <span>{{ xpProgress.current_xp_in_level }} / {{ xpProgress.xp_needed_for_next_level }} XP</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                            <div
                                class="bg-gradient-to-r from-indigo-500 to-purple-500 h-4 rounded-full transition-all duration-500 ease-out relative overflow-hidden"
                                style="width: {{ xpProgress.percentage_progress }}%"
                            >
                                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-shimmer"></div>
                            </div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-2">
                            <span>{{ xpProgress.percentage_progress|number_format(1) }}%</span>
                            <span>
                                {% if xpProgress.is_max_level %}
                                    üèÜ Level Maksimal!
                                {% else %}
                                    {{ xpProgress.xp_to_next_level }} XP lagi
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    <!-- Level System Reference -->
                    <div class="border-t border-indigo-200 pt-4">
                        <div class="text-xs font-medium text-gray-700 mb-3">Sistem Level:</div>
                        <div class="grid grid-cols-5 gap-2 text-center">
                            <div class="bg-white rounded-lg px-2 py-3 border {{ pegawai.currentLevel == 1 ? 'border-indigo-400 ring-2 ring-indigo-300' : 'border-gray-200' }}">
                                <div class="text-2xl mb-1">üå±</div>
                                <div class="text-[10px] font-medium text-gray-800">Pemula</div>
                                <div class="text-[9px] text-gray-500">0-3.7K</div>
                            </div>
                            <div class="bg-white rounded-lg px-2 py-3 border {{ pegawai.currentLevel == 2 ? 'border-indigo-400 ring-2 ring-indigo-300' : 'border-gray-200' }}">
                                <div class="text-2xl mb-1">üåø</div>
                                <div class="text-[10px] font-medium text-gray-800">Aktor Kebaikan</div>
                                <div class="text-[9px] text-gray-500">3.7K-9.4K</div>
                            </div>
                            <div class="bg-white rounded-lg px-2 py-3 border {{ pegawai.currentLevel == 3 ? 'border-indigo-400 ring-2 ring-indigo-300' : 'border-gray-200' }}">
                                <div class="text-2xl mb-1">üå∫</div>
                                <div class="text-[10px] font-medium text-gray-800">Penggerak Semangat</div>
                                <div class="text-[9px] text-gray-500">9.4K-17.8K</div>
                            </div>
                            <div class="bg-white rounded-lg px-2 py-3 border {{ pegawai.currentLevel == 4 ? 'border-indigo-400 ring-2 ring-indigo-300' : 'border-gray-200' }}">
                                <div class="text-2xl mb-1">üåû</div>
                                <div class="text-[10px] font-medium text-gray-800">Inspirator Gembira</div>
                                <div class="text-[9px] text-gray-500">17.8K-30K</div>
                            </div>
                            <div class="bg-white rounded-lg px-2 py-3 border {{ pegawai.currentLevel == 5 ? 'border-indigo-400 ring-2 ring-indigo-300' : 'border-gray-200' }}">
                                <div class="text-2xl mb-1">üèÜ</div>
                                <div class="text-[10px] font-medium text-gray-800">Teladan Kinerja</div>
                                <div class="text-[9px] text-gray-500">30K+</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Link to Leaderboard -->
                    <div class="mt-4 text-center">
                        <a href="{{ path('app_ikhlas_leaderboard') }}" class="inline-flex items-center gap-2 text-sm text-indigo-600 hover:text-indigo-700 font-medium transition-colors">
                            <span>üèÜ</span>
                            <span>Lihat Leaderboard Bulanan</span>
                            <span>‚Üí</span>
                        </a>
                    </div>
                </div>

                <!-- Data Profil (Read-only) -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">üìã</span>
                        Data Pegawai
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- NIP -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <label class="block text-sm font-medium text-gray-600 mb-1">NIP</label>
                            <div class="text-gray-900 font-mono">{{ pegawai.nip }}</div>
                        </div>

                        <!-- Nama Lengkap -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Nama Lengkap</label>
                            <div class="text-gray-900">{{ pegawai.nama }}</div>
                        </div>

                        <!-- Unit Kerja -->
                        <div class="bg-gray-50 rounded-lg p-4 md:col-span-2">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Unit Kerja</label>
                            <div class="text-gray-900">
                                {% if pegawai.unitKerjaEntity %}
                                    {{ pegawai.unitKerjaEntity.namaUnit }}
                                {% elseif pegawai.unitKerja %}
                                    {{ pegawai.unitKerja }}
                                {% else %}
                                    <span class="text-gray-400 italic">Tidak ada unit kerja</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data yang Bisa Diedit -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">‚úèÔ∏è</span>
                        Informasi Kontak
                        <span class="ml-2 text-sm text-gray-500 font-normal">(Dapat diedit)</span>
                    </h3>

                    <form id="profileForm" class="space-y-4">
                        <!-- Email -->
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                Email <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                value="{{ pegawai.email }}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors text-base"
                                placeholder="nama@email.com"
                                required
                            >
                        </div>

                        <!-- Nomor Telepon -->
                        <div>
                            <label for="nomor_telepon" class="block text-sm font-medium text-gray-700 mb-2">
                                Nomor Telepon
                            </label>
                            <input
                                type="tel"
                                id="nomor_telepon"
                                name="nomor_telepon"
                                value="{{ pegawai.nomorTelepon }}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors text-base"
                                placeholder="081234567890"
                            >
                            <p class="text-sm text-gray-500 mt-1">Format: 081234567890 atau +62812345678</p>
                        </div>

                        <!-- Tombol Update -->
                        <div class="pt-4">
                            <button
                                type="submit"
                                id="submitBtn"
                                class="w-full bg-sky-600 hover:bg-sky-700 text-white font-medium py-3 px-6 rounded-lg transition-colors focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 text-base"
                            >
                                <span id="submitText">üíæ Simpan Perubahan</span>
                                <span id="loadingText" class="hidden">‚è≥ Menyimpan...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Info Tambahan -->
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start space-x-3">
                <div class="text-blue-500 text-lg mt-0.5">üí°</div>
                <div class="text-blue-800 text-sm">
                    <p class="font-medium mb-1">Informasi Penting:</p>
                    <ul class="list-disc list-inside space-y-1 text-blue-700">
                        <li>Hanya email dan nomor telepon yang dapat diubah</li>
                        <li>Email akan digunakan untuk notifikasi sistem</li>
                        <li>Pastikan nomor telepon aktif untuk komunikasi darurat</li>
                        <li>Data lain dikelola oleh administrator</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Navigation -->
{% include 'components/bottom_nav.html.twig' with {'active_menu': 'profil'} %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('profileForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingText = document.getElementById('loadingText');
    const alertContainer = document.getElementById('alertContainer');
    const alertMessage = document.getElementById('alertMessage');

    // Handle form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Disable button dan show loading
        submitBtn.disabled = true;
        submitText.classList.add('hidden');
        loadingText.classList.remove('hidden');

        // Get form data
        const formData = new FormData(form);

        try {
            const response = await fetch('{{ path('app_profile_edit') }}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                showAlert(result.message, 'success');

                // Update form values dengan data terbaru
                if (result.data) {
                    document.getElementById('email').value = result.data.email || '';
                    document.getElementById('nomor_telepon').value = result.data.nomor_telepon || '';
                }
            } else {
                showAlert(result.message, 'error');
            }

        } catch (error) {
            console.error('Error:', error);
            showAlert('‚ùå Terjadi kesalahan koneksi. Silakan coba lagi.', 'error');
        } finally {
            // Reset button
            submitBtn.disabled = false;
            submitText.classList.remove('hidden');
            loadingText.classList.add('hidden');
        }
    });

    // Function to show alert
    function showAlert(message, type) {
        alertContainer.classList.remove('hidden');
        alertMessage.textContent = message;

        // Remove previous alert classes
        alertMessage.classList.remove('bg-green-100', 'border-green-500', 'text-green-700');
        alertMessage.classList.remove('bg-red-100', 'border-red-500', 'text-red-700');

        if (type === 'success') {
            alertMessage.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
        } else {
            alertMessage.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
        }

        // Auto hide after 5 seconds
        setTimeout(() => {
            alertContainer.classList.add('hidden');
        }, 5000);

        // Scroll to top to show alert
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Phone number input formatting
    const phoneInput = document.getElementById('nomor_telepon');
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value;
        // Remove non-numeric characters except +, -, space, and parentheses
        value = value.replace(/[^0-9+\-\s\(\)]/g, '');
        e.target.value = value;
    });
});

// Mobile touch optimization
document.addEventListener('DOMContentLoaded', function() {
    // Add touch feedback for buttons
    const buttons = document.querySelectorAll('button, a');
    buttons.forEach(button => {
        button.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.98)';
        });
        button.addEventListener('touchend', function() {
            this.style.transform = 'scale(1)';
        });
    });
});

// Handle Upload Foto Profil
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadPhotoForm');
    const photoInput = document.getElementById('photoInput');
    const uploadBtn = document.getElementById('uploadPhotoBtn');
    const uploadBtnText = document.getElementById('uploadBtnText');
    const fileSizeInfo = document.getElementById('fileSizeInfo');
    const photoPreview = document.getElementById('photoPreview');
    const alertContainer = document.getElementById('alertContainer');
    const alertMessage = document.getElementById('alertMessage');

    // Show file size when selected
    photoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const fileSizeKB = (file.size / 1024).toFixed(2);
            const maxSizeKB = 100;

            fileSizeInfo.classList.remove('hidden');

            if (fileSizeKB > maxSizeKB) {
                fileSizeInfo.textContent = `‚ö†Ô∏è Ukuran: ${fileSizeKB} KB (Melebihi batas ${maxSizeKB} KB!)`;
                fileSizeInfo.classList.add('text-red-600', 'font-semibold');
                fileSizeInfo.classList.remove('text-green-600');
                uploadBtn.disabled = true;
            } else {
                fileSizeInfo.textContent = `‚úì Ukuran: ${fileSizeKB} KB (OK)`;
                fileSizeInfo.classList.add('text-green-600', 'font-semibold');
                fileSizeInfo.classList.remove('text-red-600');
                uploadBtn.disabled = false;
            }
        }
    });

    // Handle form submission
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const file = photoInput.files[0];
        if (!file) {
            showAlert('‚ùå Pilih foto terlebih dahulu', 'error');
            return;
        }

        // Validasi size di client side
        const fileSizeKB = file.size / 1024;
        if (fileSizeKB > 100) {
            showAlert(`‚ùå Ukuran file terlalu besar (${fileSizeKB.toFixed(2)} KB). Maksimal 100 KB`, 'error');
            return;
        }

        // Disable button dan show loading
        uploadBtn.disabled = true;
        uploadBtnText.textContent = '‚è≥ Mengupload...';

        try {
            const formData = new FormData();
            formData.append('photo', file);

            const response = await fetch('/profile/api/upload-photo', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                showAlert(result.message, 'success');

                // Update preview with new photo
                photoPreview.innerHTML = `
                    <img src="${result.photo_path}?t=${Date.now()}"
                         alt="Foto Profil"
                         class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg">
                `;

                // Reset form
                uploadForm.reset();
                fileSizeInfo.classList.add('hidden');

                // Reload page after 2 seconds to update all instances
                setTimeout(() => {
                    window.location.reload();
                }, 2000);

            } else {
                showAlert(result.message, 'error');
            }

        } catch (error) {
            console.error('Upload error:', error);
            showAlert('‚ùå Terjadi kesalahan saat mengupload foto', 'error');
        } finally {
            uploadBtn.disabled = false;
            uploadBtnText.textContent = 'üì§ Upload Foto';
        }
    });

    function showAlert(message, type) {
        alertContainer.classList.remove('hidden');
        alertMessage.textContent = message;

        alertMessage.classList.remove('bg-green-100', 'border-green-500', 'text-green-700');
        alertMessage.classList.remove('bg-red-100', 'border-red-500', 'text-red-700');

        if (type === 'success') {
            alertMessage.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
        } else {
            alertMessage.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
        }

        setTimeout(() => {
            alertContainer.classList.add('hidden');
        }, 5000);

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
});
</script>

<style>
/* Mobile-first responsive design */
@media (max-width: 640px) {
    .container {
        padding-left: 1rem;
        padding-right: 1rem;
    }

    .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
    }
}

/* Ensure touch targets are large enough */
input, button {
    min-height: 48px;
}

/* Better focus states for accessibility */
input:focus, button:focus {
    outline: 2px solid #0ea5e9;
    outline-offset: 2px;
}

/* Smooth transitions */
* {
    transition: all 0.2s ease;
}

/* Prevent zoom on iOS Safari when focusing inputs */
input[type="email"], input[type="tel"] {
    font-size: 16px;
}
</style>
{% endblock %}