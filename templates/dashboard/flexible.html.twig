{% extends 'base.html.twig' %}

{% block title %}Dashboard - Gembira{% endblock %}

{% block body %}
<!-- Header - Konsisten dengan desain awal -->
<div class="bg-gradient-to-r from-sky-400 to-sky-500 text-white sticky top-0 z-40 shadow-lg">
    <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <h1 class="text-lg font-bold">ü§≤ GEMBIRA</h1>
                <p class="text-sky-100 text-xs">Gerakan Munajat Bersama Untuk Kinerja</p>
            </div>
            
            <!-- User Info & Logout - Enhanced -->
            <div class="relative z-50">
                <button id="userMenuButton" onclick="toggleDropdown()" class="flex items-center space-x-2 bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 rounded-lg text-sm backdrop-blur-sm transition-all">
                    <div class="text-right">
                        <div class="font-medium">{{ pegawai.nama }}</div>
                        <div class="text-xs text-sky-100">{{ pegawai.nip }}</div>
                    </div>
                    <div class="text-lg">üë§</div>
                    <!-- Dropdown Arrow -->
                    <svg id="dropdownArrow" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <!-- Dropdown Menu - Enhanced with better z-index and positioning -->
                <div id="userDropdown" class="hidden absolute right-0 top-full mt-2 bg-white border border-gray-200 rounded-lg shadow-xl min-w-[220px] z-[60] transform opacity-0 scale-95 transition-all duration-200">
                    <div class="p-3 border-b border-gray-200 bg-gray-50 rounded-t-lg">
                        <div class="text-sm font-medium text-gray-900">{{ pegawai.nama }}</div>
                        <div class="text-xs text-gray-500">{{ pegawai.jabatan }}</div>
                        {% if pegawai.unitKerja %}
                        <div class="text-xs text-gray-400">{{ pegawai.unitKerja }}</div>
                        {% endif %}
                    </div>
                    <div class="py-1">
                        <a href="{{ path('app_profile_view') }}" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                            <span class="mr-3">üë§</span>
                            <span>Profil</span>
                        </a>
                        <a href="{{ path('app_absensi_dashboard') }}" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-green-50 hover:text-green-600 transition-colors">
                            <span class="mr-3">ü§≤</span>
                            <span>Dashboard Absensi</span>
                        </a>
                        <a href="{{ path('app_profile_change_password') }}" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition-colors">
                            <span class="mr-3">üîê</span>
                            <span>Ganti Password</span>
                        </a>
                        <a href="{{ path('app_profile_tanda_tangan') }}" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-yellow-50 hover:text-yellow-600 transition-colors">
                            <span class="mr-3">üìù</span>
                            <span>Tanda Tangan</span>
                        </a>
                        <hr class="my-1">
                        {% include 'components/logout_button.html.twig' with {
                            'style': 'w-full flex items-center px-4 py-3 text-sm text-red-600 hover:bg-red-50 hover:text-red-700 border-0 bg-transparent transition-colors',
                            'text': 'Logout',
                            'icon': 'üö™'
                        } %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Welcome Info - Konsisten dengan desain lama -->
        <div class="mt-3 bg-white bg-opacity-20 rounded-lg p-3 backdrop-blur-sm">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium">Selamat datang!</p>
                    <p class="text-xs text-sky-100">{{ waktu_sekarang|date('d F Y') }}</p>
                </div>
                <div class="text-right">
                    <div class="text-lg font-bold" id="jam-sekarang-header">{{ waktu_sekarang|date('H:i:s') }} WITA</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Banner Slide Informasi - Sama seperti desain lama -->
<div class="bg-gradient-to-r from-sky-300 to-sky-400 py-4 shadow-sm">
    <div class="container mx-auto px-4">
        <div class="relative overflow-hidden rounded-lg">
            <div class="flex transition-transform duration-500 ease-in-out" id="banner-slider">
                {% if banners is not empty %}
                    {% for banner in banners %}
                    <!-- Slide {{ loop.index }} -->
                    {% if banner.hasLink %}
                    <a href="{{ banner.link }}" target="_blank" rel="noopener noreferrer" class="block min-w-full">
                    {% endif %}
                        <div class="min-w-full bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-4 {% if banner.hasLink %}hover:bg-opacity-100 hover:shadow-md transition-all duration-200 cursor-pointer{% endif %}">
                            <div class="flex items-center space-x-4">
                                <!-- Banner Image -->
                                <div class="flex-shrink-0">
                                    {% if banner.imagePath %}
                                        <img src="{{ asset('uploads/sliders/' ~ banner.imagePath) }}" 
                                             alt="{{ banner.title }}" 
                                             class="w-16 h-16 object-cover rounded-lg shadow-sm">
                                    {% else %}
                                        <div class="w-16 h-16 bg-sky-100 rounded-lg flex items-center justify-center">
                                            <span class="text-2xl">üì¢</span>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Banner Text -->
                                <div class="flex-1 text-left">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h3 class="font-semibold text-sky-800 text-lg">{{ banner.title }}</h3>
                                        {% if banner.hasLink %}
                                            <svg class="w-4 h-4 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                            </svg>
                                        {% endif %}
                                    </div>
                                    <p class="text-sm text-sky-600 leading-relaxed">{{ banner.description }}</p>
                                </div>
                            </div>
                        </div>
                    {% if banner.hasLink %}
                    </a>
                    {% endif %}
                    {% endfor %}
                {% else %}
                    <!-- Default Slide jika tidak ada banner -->
                    <div class="min-w-full bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-4">
                        <div class="flex items-center space-x-4">
                            <!-- Default Icon -->
                            <div class="flex-shrink-0">
                                <div class="w-16 h-16 bg-sky-100 rounded-lg flex items-center justify-center">
                                    <span class="text-2xl">üì¢</span>
                                </div>
                            </div>
                            
                            <!-- Default Text -->
                            <div class="flex-1 text-left">
                                <h3 class="font-semibold text-sky-800 text-lg mb-1">Selamat Datang</h3>
                                <p class="text-sm text-sky-600 leading-relaxed">Jangan lupa absensi sesuai jadwal yang ditentukan</p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <!-- Slide Indicators -->
            <div class="flex justify-center mt-3 space-x-2">
                {% if banners is not empty %}
                    {% for banner in banners %}
                    <button class="w-2 h-2 rounded-full bg-white bg-opacity-60 transition-all" onclick="if(typeof goToSlide === 'function') goToSlide({{ loop.index0 }})" id="indicator-{{ loop.index0 }}"></button>
                    {% endfor %}
                {% else %}
                    <button class="w-2 h-2 rounded-full bg-white bg-opacity-60 transition-all" onclick="if(typeof goToSlide === 'function') goToSlide(0)" id="indicator-0"></button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Main Content - Konsisten dengan desain lama -->
<div class="bg-gradient-to-b from-sky-50 to-sky-100 min-h-screen pb-20">
<div class="container mx-auto px-4 py-6">

    <!-- Card Ranking Pribadi & Group -->
    {% if ranking_pribadi is defined and ranking_pribadi.posisi > 0 %}
    <div class="bg-white rounded-xl shadow-sm p-3 sm:p-4 mb-6 border border-sky-200">
        <!-- Ranking Pribadi -->
        <div class="text-center mb-4">
            <div class="text-xs sm:text-sm font-bold text-sky-800" data-ranking-pribadi>
                üèÖ Ranking Anda: #{{ ranking_pribadi.posisi }} dari {{ ranking_pribadi.total_pegawai }} ({{ ranking_pribadi.persentase }}%) {{ ranking_pribadi.status }}
            </div>
        </div>

        <!-- PERBAIKAN RANKING GROUP - SESUAI FORMAT YANG DIMINTA USER -->
        {% if ranking_group is defined and ranking_group.posisi > 0 %}
        <div class="bg-sky-50 rounded-lg p-2 sm:p-3 text-center">
            <div class="text-xs sm:text-sm font-medium text-sky-700 mb-1">üìä Ranking Group</div>
            <div class="text-xs sm:text-sm font-bold text-sky-800" data-ranking-group>
                Bagian {{ ranking_group.nama_unit }}: #{{ ranking_group.posisi }} dari {{ ranking_group.total_pegawai }} Pegawai
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- Jika belum ada data ranking -->
    <div class="bg-white rounded-xl shadow-sm p-3 sm:p-4 mb-6 border border-sky-200">
        <div class="text-center">
            <div class="text-xl sm:text-2xl mb-2">üìä</div>
            <div class="text-xs sm:text-sm font-medium text-gray-600">Data Ranking Belum Tersedia</div>
            <div class="text-xs text-gray-500">Mulai absen rutin untuk melihat ranking Anda</div>
        </div>
    </div>
    {% endif %}

    <!-- Informasi Hari dan Kategori Absensi -->
    <div class="bg-white bg-opacity-80 backdrop-blur-sm border border-sky-200 rounded-xl p-4 mb-6">
        <div class="flex items-center">
            <div class="text-2xl mr-3">üìÖ</div>
            <div>
                <div class="font-medium text-sky-800">Hari {{ hari_ini }}</div>
                <div class="text-sm text-sky-600">{{ kartu_absensi|length }} kategori absensi tersedia</div>
            </div>
        </div>
    </div>

    <!-- Menu Icon Grid - FOKUS UTAMA: Format grid sederhana seperti desain lama -->
    <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
        {% for kartu in kartu_absensi %}
        <!-- Logika sederhana: hanya cek bisa_absen untuk menentukan status aktif -->
        {% set is_available = kartu.bisa_absen %}
        {% set icon_bg_color = is_available ? 'bg-white' : 'bg-gray-200' %}
        {% set icon_text_color = is_available ? 'text-sky-600' : 'text-gray-400' %}
        {% set label_text_color = is_available ? 'text-sky-800' : 'text-gray-500' %}
        
        <div class="text-center group">
            <!-- Tombol aksi sederhana: aktif atau nonaktif -->
            {% if is_available %}
                <a href="{{ path('app_absensi_proses', {'id': kartu.jadwal.id}) }}" 
                   class="block transition-all duration-200 transform hover:scale-105 active:scale-95 touch-manipulation">
            {% else %}
                <div class="block">
            {% endif %}
            
                <!-- Icon Container - Konsisten dengan desain lama -->
                <div class="{{ icon_bg_color }} rounded-2xl shadow-md p-6 mb-3 border-2 border-sky-200 {% if is_available %}hover:shadow-lg hover:border-sky-300{% endif %}">
                    <div class="text-4xl {{ icon_text_color }} transition-colors">{{ kartu.jadwal.emoji }}</div>
                    
                    <!-- Indikator status sederhana - hanya hijau (aktif) atau abu (nonaktif) -->
                    {% if is_available %}
                        <div class="mt-2 w-2 h-2 bg-green-500 rounded-full mx-auto animate-pulse" title="Tersedia sekarang"></div>
                    {% else %}
                        <div class="mt-2 w-2 h-2 bg-gray-400 rounded-full mx-auto" title="Tidak tersedia"></div>
                    {% endif %}
                </div>
                
                <!-- Label Text - Format sederhana: Nama, Jam, Status Aksi -->
                <div class="px-1">
                    <p class="text-sm font-semibold {{ label_text_color }} leading-tight mb-1">{{ kartu.jadwal.namaJadwal }}</p>
                    <p class="text-xs text-gray-500">{{ kartu.jadwal.jamMulai|date('H:i') }} - {{ kartu.jadwal.jamSelesai|date('H:i') }}</p>
                    
                    <!-- Status aksi sederhana berdasarkan konfigurasi jadwal -->
                    {% if is_available %}
                        {% if kartu.sudah_absen %}
                            <p class="text-xs text-blue-600 mt-1">‚úÖ Sudah Absen</p>
                        {% elseif kartu.jadwal.isPerluQrCode and kartu.jadwal.isPerluKamera %}
                            <p class="text-xs text-green-600 mt-1">üì±üì∑ Scan QR & Foto</p>
                        {% elseif kartu.jadwal.isPerluQrCode %}
                            <p class="text-xs text-green-600 mt-1">üì± Scan QR</p>
                        {% elseif kartu.jadwal.isPerluKamera %}
                            <p class="text-xs text-green-600 mt-1">üì∑ Ambil Foto</p>
                        {% else %}
                            <p class="text-xs text-green-600 mt-1">‚úã Klik Absen</p>
                        {% endif %}
                    {% else %}
                        <p class="text-xs text-gray-400 mt-1">‚è∞ Diluar Jam</p>
                    {% endif %}
                </div>
                
            <!-- Tutup tag sesuai kondisi -->
            {% if is_available %}
                </a>
            {% else %}
                </div>
            {% endif %}
        </div>
        {% else %}
        <!-- Pesan jika tidak ada jadwal - sesuai desain lama -->
        <div class="col-span-full">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                <div class="text-6xl mb-4">üìã</div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Tidak Ada Absensi Hari Ini</h3>
                <p class="text-gray-500 text-sm">Tidak ada jadwal absensi yang tersedia untuk hari {{ hari_ini }}.</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Garis Pembatas -->
    <div class="my-6">
        <hr class="border-sky-200">
    </div>

    <!-- Card Top 10 Pegawai (Expandable) -->
    {% if top_10_pegawai is defined and top_10_pegawai|length > 0 %}
    <div class="bg-white rounded-xl shadow-sm border border-sky-200 mb-6">
        <!-- Header Card dengan tombol expand/collapse -->
        <div class="bg-gradient-to-r from-sky-500 to-sky-600 text-white p-3 sm:p-4 rounded-t-xl cursor-pointer shadow-md hover:from-sky-600 hover:to-sky-700 transition-all duration-200"
             onclick="toggleTop10Table()" id="top10Header">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span class="text-lg sm:text-xl mr-2">üèÜ</span>
                    {# PERBAIKAN JUDUL - SESUAI PERMINTAAN USER #}
                    <h3 class="text-base sm:text-lg font-semibold text-white">Top 10 Pegawai (Global)</h3>
                </div>
                <div class="flex items-center">
                    <span class="text-xs sm:text-sm mr-2 text-sky-100 font-medium">Lihat Detail</span>
                    <svg id="top10Arrow" class="w-4 h-4 sm:w-5 sm:h-5 transition-transform duration-200 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Tabel Top 10 (Hidden by default) -->
        <div id="top10Table" class="hidden overflow-x-auto">
            <table class="w-full">
                {# PERBAIKAN HEADER TABEL - SESUAI FORMAT YANG DIMINTA USER #}
                <thead class="bg-sky-100 border-b border-sky-200">
                    <tr class="text-left">
                        <th class="px-2 sm:px-4 py-2 sm:py-3 text-xs font-semibold text-sky-800 uppercase tracking-wider">Nama</th>
                        <th class="px-2 sm:px-4 py-2 sm:py-3 text-xs font-semibold text-sky-800 uppercase tracking-wider hidden lg:table-cell">Unit Kerja</th>
                        <th class="px-2 sm:px-4 py-2 sm:py-3 text-xs font-semibold text-sky-800 uppercase tracking-wider text-center">% Kehadiran</th>
                        <th class="px-2 sm:px-4 py-2 sm:py-3 text-xs font-semibold text-sky-800 uppercase tracking-wider text-center">Badge</th>
                    </tr>
                </thead>
                <tbody id="top10TableBody" class="bg-white divide-y divide-gray-200">
                    {# PERBAIKAN BODY TABEL - SESUAI FORMAT YANG DIMINTA USER #}
                    {% for pegawai_top in top_10_pegawai %}
                    <tr class="{% if loop.index <= 3 %}bg-sky-50 border-sky-200{% else %}hover:bg-gray-50{% endif %} transition-colors duration-150">
                        <!-- Nama dengan nomor urut -->
                        <td class="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm {% if loop.index <= 3 %}font-bold text-sky-800{% else %}text-gray-900 font-medium{% endif %}">
                            <div class="flex items-center">
                                <span class="w-4 sm:w-6 text-center text-xs {% if loop.index <= 3 %}text-sky-600 font-bold{% else %}text-gray-500{% endif %} mr-1 sm:mr-2">{{ loop.index }}.</span>
                                <div class="min-w-0 flex-1">
                                    <div class="truncate">{{ pegawai_top.nama }}</div>
                                    <!-- Show unit kerja on mobile below name -->
                                    <div class="lg:hidden text-xs text-gray-500 truncate">{{ pegawai_top.unit_kerja|default('Unit Tidak Diketahui') }}</div>
                                </div>
                            </div>
                        </td>
                        <!-- Unit Kerja (hidden on mobile/tablet, shown on desktop) -->
                        <td class="px-2 sm:px-4 py-2 sm:py-3 text-xs {% if loop.index <= 3 %}text-sky-700{% else %}text-gray-600{% endif %} hidden lg:table-cell">
                            <span class="truncate">{{ pegawai_top.unit_kerja|default('Unit Tidak Diketahui') }}</span>
                        </td>
                        <!-- % Kehadiran -->
                        <td class="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-bold text-center {% if loop.index <= 3 %}text-sky-800{% else %}text-gray-900{% endif %}">
                            {{ pegawai_top.persentase }}%
                        </td>
                        <!-- Badge -->
                        <td class="px-2 sm:px-4 py-2 sm:py-3 text-center">
                            <span class="text-lg sm:text-xl drop-shadow-sm">{{ pegawai_top.status }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Footer Card -->
        <div id="top10Footer" class="hidden bg-gray-50 px-4 py-3 rounded-b-xl">
            <p class="text-xs text-gray-500 text-center">
                * Ranking berdasarkan persentase kehadiran absensi rutin. Tie-breaking: Persentase ‚Üí Waktu absen pertama.
            </p>
        </div>
    </div>
    {% endif %}

</div>
</div>

<!-- Navigasi Bawah - TETAP PERTAHANKAN -->
<div class="fixed bottom-0 left-0 right-0 bg-sky-400 shadow-2xl border-t border-sky-500 z-50">
    <div class="grid grid-cols-5 text-center">
        <!-- Home -->
        <a href="{{ path('app_dashboard') }}" class="flex flex-col items-center py-3 px-2 text-white bg-sky-600 rounded-lg mx-1">
            <div class="text-lg mb-1">üè†</div>
            <div class="text-xs font-medium">Home</div>
        </a>
        
        <!-- Laporan -->
        <a href="{{ path('app_user_laporan') }}" class="flex flex-col items-center py-3 px-2 text-gray-200 hover:text-white hover:bg-sky-500 transition-colors rounded-lg mx-1">
            <div class="text-lg mb-1">üìä</div>
            <div class="text-xs">Laporan</div>
        </a>
        
        <!-- Kalender -->
        <a href="{{ path('app_user_kalender') }}" class="flex flex-col items-center py-3 px-2 text-gray-200 hover:text-white hover:bg-sky-500 transition-colors rounded-lg mx-1">
            <div class="text-lg mb-1">üìÖ</div>
            <div class="text-xs">Kalender</div>
        </a>
        
        <!-- Notifikasi -->
        <a href="{{ path('app_notifikasi_index') }}" class="flex flex-col items-center py-3 px-2 text-gray-200 hover:text-white hover:bg-sky-500 transition-colors rounded-lg mx-1">
            <div class="text-lg mb-1">üîî</div>
            <div class="text-xs">Notifikasi</div>
        </a>
        
        <!-- Profil -->
        <a href="{{ path('app_profile_view') }}" class="flex flex-col items-center py-3 px-2 text-gray-200 hover:text-white hover:bg-sky-500 transition-colors rounded-lg mx-1">
            <div class="text-lg mb-1">üë§</div>
            <div class="text-xs">Profil</div>
        </a>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<!-- JavaScript untuk fungsi dropdown dan slider - dengan error handling -->
<script>
    // Error handling untuk mencegah crash JavaScript
    window.addEventListener('error', function(e) {
        console.log('JavaScript Error handled:', e.message);
        return true; // Prevent default browser error handling
    });
    
    // Unhandled promise rejection handler
    window.addEventListener('unhandledrejection', function(e) {
        console.log('Promise rejection handled:', e.reason);
        e.preventDefault();
    });
    
    // Safe DOM query helper function
    function safeGetElement(id) {
        try {
            return document.getElementById(id);
        } catch (error) {
            console.warn('Error getting element with id:', id, error);
            return null;
        }
    }

    // Enhanced dropdown user menu dengan animasi dan better UX
    function toggleDropdown() {
        try {
            const dropdown = safeGetElement('userDropdown');
            const arrow = safeGetElement('dropdownArrow');

            if (!dropdown) {
                console.warn('Dropdown element not found');
                return;
            }

            const isHidden = dropdown.classList.contains('hidden');

            if (isHidden) {
                // Show dropdown with animation
                dropdown.classList.remove('hidden');
                // Force reflow
                dropdown.offsetHeight;
                dropdown.classList.remove('opacity-0', 'scale-95');
                dropdown.classList.add('opacity-100', 'scale-100');

                // Rotate arrow
                if (arrow) {
                    arrow.classList.add('rotate-180');
                }
            } else {
                // Hide dropdown with animation
                dropdown.classList.remove('opacity-100', 'scale-100');
                dropdown.classList.add('opacity-0', 'scale-95');

                // Rotate arrow back
                if (arrow) {
                    arrow.classList.remove('rotate-180');
                }

                // Hide after animation
                setTimeout(() => {
                    dropdown.classList.add('hidden');
                }, 200);
            }

            // Tutup dropdown jika klik di luar - hanya tambahkan listener sekali
            if (!window.dropdownListenerAdded) {
                document.addEventListener('click', function(event) {
                    try {
                        const button = event.target.closest('#userMenuButton, button[onclick*="toggleDropdown"]');
                        if (!button && !dropdown.contains(event.target)) {
                            closeDropdown();
                        }
                    } catch (e) {
                        console.error('Error in dropdown click handler:', e);
                    }
                });
                window.dropdownListenerAdded = true;
            }
        } catch (error) {
            console.error('Error in toggleDropdown:', error);
        }
    }

    // Helper function to close dropdown
    function closeDropdown() {
        try {
            const dropdown = safeGetElement('userDropdown');
            const arrow = safeGetElement('dropdownArrow');

            if (dropdown && !dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('opacity-100', 'scale-100');
                dropdown.classList.add('opacity-0', 'scale-95');

                if (arrow) {
                    arrow.classList.remove('rotate-180');
                }

                setTimeout(() => {
                    dropdown.classList.add('hidden');
                }, 200);
            }
        } catch (error) {
            console.error('Error in closeDropdown:', error);
        }
    }
    
    // Update waktu real-time dengan error handling
    function updateTime() {
        try {
            const now = new Date();
            const jamHeaderElement = safeGetElement('jam-sekarang-header');
            if (jamHeaderElement) {
                jamHeaderElement.textContent = now.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: 'Asia/Makassar'
                }) + ' WITA';
            }
        } catch (error) {
            console.error('Error in updateTime:', error);
        }
    }

    // Banner slider functionality - dengan jumlah slide dinamis dan validasi
    let currentSlide = 0;
    const slides = Math.max({% if banners is not empty %}{{ banners|length }}{% else %}1{% endif %}, 1);

    function goToSlide(slideIndex) {
        try {
            if (typeof slideIndex !== 'number' || slideIndex < 0 || slideIndex >= slides) {
                console.warn('Invalid slide index:', slideIndex);
                return;
            }
            
            currentSlide = slideIndex;
            const slider = safeGetElement('banner-slider');
            if (!slider) {
                console.warn('Banner slider element not found');
                return;
            }
            
            slider.style.transform = `translateX(-${slideIndex * 100}%)`;
            
            // Update indicators
            for (let i = 0; i < slides; i++) {
                const indicator = safeGetElement(`indicator-${i}`);
                if (indicator) {
                    if (i === slideIndex) {
                        indicator.classList.remove('bg-white', 'bg-opacity-60');
                        indicator.classList.add('bg-white', 'bg-opacity-100');
                    } else {
                        indicator.classList.remove('bg-white', 'bg-opacity-100');
                        indicator.classList.add('bg-white', 'bg-opacity-60');
                    }
                }
            }
        } catch (error) {
            console.error('Error in goToSlide:', error);
        }
    }

    function nextSlide() {
        try {
            if (slides <= 0) {
                console.warn('No slides available');
                return;
            }
            currentSlide = (currentSlide + 1) % slides;
            goToSlide(currentSlide);
        } catch (error) {
            console.error('Error in nextSlide:', error);
        }
    }

    // Auto slide setiap 5 detik - hanya jika ada lebih dari 1 slide
    if (slides > 1) {
        try {
            setInterval(nextSlide, 5000);
        } catch (error) {
            console.error('Error setting up auto slide:', error);
        }
    }

    // Update ranking data secara periodik (setiap 5 menit)
    function updateRankingData() {
        try {
            fetch('{{ path('app_absensi_api_ranking_update') }}')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateRankingDisplay(data);
                    } else {
                        console.warn('Gagal update ranking:', data.message);
                    }
                })
                .catch(error => {
                    console.warn('Error update ranking:', error);
                });
        } catch (error) {
            console.error('Error in updateRankingData:', error);
        }
    }

    // Function untuk toggle expand/collapse Top 10 table
    function toggleTop10Table() {
        try {
            const table = safeGetElement('top10Table');
            const footer = safeGetElement('top10Footer');
            const arrow = safeGetElement('top10Arrow');
            const headerText = document.querySelector('#top10Header .text-sm');

            if (!table) return;

            const isHidden = table.classList.contains('hidden');

            if (isHidden) {
                // Expand table
                table.classList.remove('hidden');
                if (footer) footer.classList.remove('hidden');
                if (arrow) arrow.classList.add('rotate-180');
                if (headerText) headerText.textContent = 'Sembunyikan';
            } else {
                // Collapse table
                table.classList.add('hidden');
                if (footer) footer.classList.add('hidden');
                if (arrow) arrow.classList.remove('rotate-180');
                if (headerText) headerText.textContent = 'Lihat Detail';
            }
        } catch (error) {
            console.error('Error in toggleTop10Table:', error);
        }
    }

    // Function untuk update tampilan ranking
    function updateRankingDisplay(data) {
        try {
            const rankingPribadi = data.ranking_pribadi;
            const rankingGroup = data.ranking_group;
            const top10 = data.top_10_pegawai;

            // Update ranking pribadi jika ada element
            const rankingPribadiElement = document.querySelector('[data-ranking-pribadi]');
            if (rankingPribadiElement && rankingPribadi.posisi > 0) {
                rankingPribadiElement.textContent = `üèÖ Ranking Anda: #${rankingPribadi.posisi} dari ${rankingPribadi.total_pegawai} (${rankingPribadi.persentase}%) ${rankingPribadi.status}`;
            }

            // Update ranking group jika ada element - PERBAIKAN FORMAT SESUAI PERMINTAAN USER
            const rankingGroupElement = document.querySelector('[data-ranking-group]');
            if (rankingGroupElement && rankingGroup.posisi > 0) {
                rankingGroupElement.textContent = `Bagian ${rankingGroup.nama_unit}: #${rankingGroup.posisi} dari ${rankingGroup.total_pegawai} Pegawai`;
            }

            // Update top 10 table jika ada element - PERBAIKAN STRUKTUR TABEL TANPA NIP
            const top10TableBody = safeGetElement('top10TableBody');
            if (top10TableBody && top10.length > 0) {
                let tableHtml = '';
                top10.forEach((pegawai, index) => {
                    const isTop3 = index < 3;
                    const rowClasses = isTop3 ? 'bg-sky-50 border-sky-200' : 'hover:bg-gray-50';
                    const namaClasses = isTop3 ? 'font-bold text-sky-800' : 'text-gray-900 font-medium';
                    const rankClasses = isTop3 ? 'text-sky-600 font-bold' : 'text-gray-500';
                    const unitClasses = isTop3 ? 'text-sky-700' : 'text-gray-600';
                    const percentClasses = isTop3 ? 'text-sky-800' : 'text-gray-900';
                    const unitKerja = pegawai.unit_kerja || 'Unit Tidak Diketahui';

                    tableHtml += `
                        <tr class="${rowClasses} transition-colors duration-150">
                            <td class="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm ${namaClasses}">
                                <div class="flex items-center">
                                    <span class="w-4 sm:w-6 text-center text-xs ${rankClasses} mr-1 sm:mr-2">${index + 1}.</span>
                                    <div class="min-w-0 flex-1">
                                        <div class="truncate">${pegawai.nama}</div>
                                        <div class="lg:hidden text-xs text-gray-500 truncate">${unitKerja}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-2 sm:px-4 py-2 sm:py-3 text-xs ${unitClasses} hidden lg:table-cell">
                                <span class="truncate">${unitKerja}</span>
                            </td>
                            <td class="px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-bold text-center ${percentClasses}">${pegawai.persentase}%</td>
                            <td class="px-2 sm:px-4 py-2 sm:py-3 text-center">
                                <span class="text-lg sm:text-xl drop-shadow-sm">${pegawai.status}</span>
                            </td>
                        </tr>
                    `;
                });
                top10TableBody.innerHTML = tableHtml;
            }
        } catch (error) {
            console.error('Error updating ranking display:', error);
        }
    }

    // Initialize pada load
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Update waktu setiap detik
            updateTime();
            setInterval(updateTime, 1000);

            // Set slide pertama sebagai aktif
            if (slides > 0) {
                goToSlide(0);
            }

            // Update ranking setiap 5 menit
            setInterval(updateRankingData, 5 * 60 * 1000);
        } catch (error) {
            console.error('Error in DOMContentLoaded initialization:', error);
        }
    });
</script>

<!-- Additional CSS for Top 10 Table -->
<style>
    /* Enhanced color contrast for better readability */
    .text-sky-800 {
        color: #075985 !important;
    }

    .text-sky-700 {
        color: #0369a1 !important;
    }

    .text-sky-600 {
        color: #0284c7 !important;
    }

    .bg-sky-50 {
        background-color: #f0f9ff !important;
    }

    .bg-sky-100 {
        background-color: #e0f2fe !important;
    }

    /* Header styling with better contrast */
    #top10Header {
        background: linear-gradient(135deg, #d97706 0%, #92400e 100%);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    #top10Header:hover {
        background: linear-gradient(135deg, #c2410c 0%, #7c2d12 100%);
    }

    /* Better table styling for mobile */
    @media (max-width: 640px) {
        #top10Table table {
            font-size: 0.75rem;
        }

        #top10Table th,
        #top10Table td {
            padding: 0.5rem 0.75rem;
        }

        .truncate {
            max-width: 120px;
        }
    }

    /* Smooth transitions for expand/collapse */
    #top10Table {
        transition: max-height 0.3s ease-in-out;
    }

    /* Enhanced hover effects for table rows */
    #top10TableBody tr:hover:not(.bg-sky-50) {
        background-color: #f9fafb !important;
    }

    #top10TableBody tr.bg-sky-50:hover {
        background-color: #e0f2fe !important;
    }

    /* Better mobile responsiveness for NIP column */
    @media (max-width: 480px) {
        .nip-mobile {
            display: none;
        }
    }

    /* Enhanced arrow rotation */
    #top10Arrow {
        transition: transform 0.3s ease-in-out;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
    }

    /* Better touch targets */
    #top10Header {
        min-height: 60px;
        user-select: none;
    }

    /* Enhanced badge visibility */
    .drop-shadow-sm {
        filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.05));
    }

    /* Table border improvements */
    #top10Table table {
        border-collapse: separate;
        border-spacing: 0;
    }

    #top10Table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
    }
</style>
{% endblock %}