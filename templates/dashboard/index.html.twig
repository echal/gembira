{% extends 'base.html.twig' %}

{% block title %}Dashboard - Gembira{% endblock %}

{% block body %}
<!-- User Header Component -->
{% include 'components/user_header.html.twig' with {
    'show_back_button': false,
    'title': 'GEMBIRA',
    'subtitle': 'Gerakan Munajat Bersama Untuk Kinerja',
    'show_welcome': true
} %}

<!-- Dynamic Banner Carousel -->
{% if sliders is defined and sliders|length > 0 %}
    <!-- Data slider tersedia: {{ sliders|length }} slider(s) -->
    {{ include('components/slider_carousel.html.twig') }}
{% else %}
    <!-- Fallback: Gunakan banner original -->
    <div class="bg-gradient-to-r from-sky-300 to-sky-400 py-4 shadow-sm">
        <div class="container mx-auto px-4">
            <div class="relative overflow-hidden rounded-lg">
                <div class="flex transition-transform duration-500 ease-in-out" id="banner-slider">
                    <!-- Slide 1 -->
                    <div class="min-w-full bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-4 text-center">
                        <div class="flex items-center justify-center space-x-3">
                            <div class="text-2xl">📢</div>
                            <div>
                                <p class="font-semibold text-sky-800">Informasi Penting</p>
                                <p class="text-sm text-sky-600">Jangan lupa absensi sesuai jadwal yang ditentukan</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Slide 2 -->
                    <div class="min-w-full bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-4 text-center">
                        <div class="flex items-center justify-center space-x-3">
                            <div class="text-2xl">🎯</div>
                            <div>
                                <p class="font-semibold text-sky-800">Tips Absensi</p>
                                <p class="text-sm text-sky-600">Pastikan lokasi GPS aktif untuk absensi yang akurat</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Slide 3 -->
                    <div class="min-w-full bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-4 text-center">
                        <div class="flex items-center justify-center space-x-3">
                            <div class="text-2xl">⏰</div>
                            <div>
                                <p class="font-semibold text-sky-800">Reminder</p>
                                <p class="text-sm text-sky-600">Pastikan absen sesuai jadwal untuk hasil optimal</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Indikator Slide -->
                <div class="flex justify-center mt-3 space-x-2">
                    <button class="w-2 h-2 rounded-full bg-white bg-opacity-60 transition-all" onclick="goToSlide(0)" id="indicator-0"></button>
                    <button class="w-2 h-2 rounded-full bg-white bg-opacity-60 transition-all" onclick="goToSlide(1)" id="indicator-1"></button>
                    <button class="w-2 h-2 rounded-full bg-white bg-opacity-60 transition-all" onclick="goToSlide(2)" id="indicator-2"></button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // Banner Slide Auto-scroll untuk fallback
    let currentSlide = 0;
    const totalSlides = 3;

    function goToSlide(index) {
        currentSlide = index;
        const slider = document.getElementById('banner-slider');
        if (slider) {
            const translateX = -currentSlide * 100;
            slider.style.transform = `translateX(${translateX}%)`;
            
            // Update indikator
            for (let i = 0; i < totalSlides; i++) {
                const indicator = document.getElementById(`indicator-${i}`);
                if (indicator) {
                    if (i === currentSlide) {
                        indicator.classList.remove('bg-white', 'bg-opacity-60');
                        indicator.classList.add('bg-white', 'bg-opacity-100');
                    } else {
                        indicator.classList.remove('bg-white', 'bg-opacity-100');
                        indicator.classList.add('bg-white', 'bg-opacity-60');
                    }
                }
            }
        }
    }

    function nextSlide() {
        currentSlide = (currentSlide + 1) % totalSlides;
        goToSlide(currentSlide);
    }

    // Auto-scroll setiap 5 detik
    setInterval(nextSlide, 5000);

    // Initialize slide pertama
    goToSlide(0);
    </script>
{% endif %}

<!-- Konten Utama -->
<div class="bg-gradient-to-b from-sky-50 to-sky-100 min-h-screen pb-20">
<div class="container mx-auto px-4 py-6">
    <!-- Informasi Waktu -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-sky-200">
        <div class="text-center">
            <div class="text-3xl font-bold text-sky-800" id="jam-sekarang">--:--:--</div>
            <div class="text-sm text-sky-600">Waktu Sekarang</div>
        </div>
    </div>

    <!-- Card Ranking Absensi Pegawai -->
    {% if ranking_pribadi is defined and ranking_pribadi.posisi > 0 %}
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-sky-200">
        <div class="text-center border-b border-gray-100 pb-3 mb-4">
            {# PERBAIKAN FORMAT RANKING GLOBAL - SESUAI PERMINTAAN USER #}
            <div class="text-lg font-bold text-sky-800" data-ranking-pribadi>
                🏅 Ranking Anda: #{{ ranking_pribadi.posisi }} dari {{ ranking_pribadi.total_pegawai }} ({{ ranking_pribadi.persentase }}%) {{ ranking_pribadi.status }}
            </div>
        </div>

        <!-- Informasi Hari dan Kategori -->
        {% if hari_ini %}
        <div class="flex items-center justify-center mb-4">
            <div class="text-lg mr-2">📅</div>
            <div class="text-center">
                <div class="font-medium text-sky-800">Hari {{ hari_ini }}</div>
                <div class="text-sm text-sky-600">{{ kartu_absensi|length }} kategori absensi tersedia</div>
            </div>
        </div>
        {% endif %}

        <!-- PERBAIKAN RANKING GROUP - SESUAI FORMAT YANG DIMINTA USER -->
        {% if ranking_group is defined and ranking_group.posisi > 0 %}
        <div class="bg-sky-50 rounded-lg p-3 mb-4">
            <div class="text-center">
                <div class="text-sm font-medium text-sky-700">📊 Ranking Group</div>
                <div class="text-lg font-bold text-sky-800" data-ranking-group>
                    Bagian {{ ranking_group.nama_unit }}: #{{ ranking_group.posisi }} dari {{ ranking_group.total_pegawai }} Pegawai
                </div>
            </div>
        </div>
        {% endif %}

        <!-- PERBAIKAN TOP 10 PEGAWAI - FORMAT TABEL SESUAI PERMINTAAN USER -->
        {% if top_10_pegawai is defined and top_10_pegawai|length > 0 %}
        <div class="bg-yellow-50 rounded-lg p-3">
            <div class="text-center mb-3">
                <div class="text-sm font-medium text-yellow-700">🏆 Top 10 Pegawai (Global)</div>
            </div>

            {# TABEL TOP 10 DENGAN FORMAT: Nama | Unit Kerja | % Kehadiran | Badge #}
            <div class="overflow-x-auto">
                <table class="w-full text-xs">
                    <thead>
                        <tr class="border-b border-yellow-200">
                            <th class="text-left py-1 px-1 text-yellow-800 font-semibold">No</th>
                            <th class="text-left py-1 px-1 text-yellow-800 font-semibold">Nama</th>
                            <th class="text-left py-1 px-1 text-yellow-800 font-semibold">Unit Kerja</th>
                            <th class="text-center py-1 px-1 text-yellow-800 font-semibold">% Kehadiran</th>
                            <th class="text-center py-1 px-1 text-yellow-800 font-semibold">Badge</th>
                        </tr>
                    </thead>
                    <tbody data-top-10>
                        {% for pegawai in top_10_pegawai %}
                        <tr class="{% if loop.index <= 3 %}font-semibold bg-yellow-100{% endif %} {% if loop.index > 1 %}border-t border-yellow-100{% endif %}">
                            <td class="py-1 px-1 text-center">{{ loop.index }}.</td>
                            <td class="py-1 px-1">{{ pegawai.nama }}</td>
                            <td class="py-1 px-1 text-xs">{{ pegawai.unit_kerja|default('Unit Tidak Diketahui') }}</td>
                            <td class="py-1 px-1 text-center font-medium">{{ pegawai.persentase }}%</td>
                            <td class="py-1 px-1 text-center">{{ pegawai.status }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- Jika belum ada data ranking -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-sky-200">
        <div class="text-center">
            <div class="text-2xl mb-2">📊</div>
            <div class="text-sm font-medium text-gray-600">Data Ranking Belum Tersedia</div>
            <div class="text-xs text-gray-500">Mulai absen rutin untuk melihat ranking Anda</div>
        </div>

        <!-- Informasi Hari tetap ditampilkan -->
        {% if hari_ini %}
        <div class="mt-4 pt-3 border-t border-gray-100">
            <div class="flex items-center justify-center">
                <div class="text-lg mr-2">📅</div>
                <div class="text-center">
                    <div class="font-medium text-sky-800">Hari {{ hari_ini }}</div>
                    <div class="text-sm text-sky-600">{{ kartu_absensi|length }} kategori absensi tersedia</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Grid Menu Icon Responsif -->
    <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
        {% for kartu in kartu_absensi %}
        <!-- Status visual berdasarkan aktif DAN jam terbuka -->
        {% set is_available = kartu.aktif and kartu.jam_terbuka %}
        {% set icon_bg_color = is_available ? 'bg-white' : 'bg-gray-200' %}
        {% set icon_text_color = is_available ? 'text-sky-600' : 'text-gray-400' %}
        {% set label_text_color = is_available ? 'text-sky-800' : 'text-gray-500' %}
        
        <div class="text-center group">
            <!-- Gunakan jam_terbuka untuk menentukan tombol aktif dan route yang benar -->
            {% if kartu.aktif and kartu.jam_terbuka %}
                <a href="{{ path('app_absensi_proses', {'id': kartu.jadwal.id}) }}"
                   class="block transition-all duration-200 transform hover:scale-105 active:scale-95 touch-manipulation">
            {% else %}
                <div class="block">
            {% endif %}
            
                <!-- Container Icon -->
                <div class="{{ icon_bg_color }} rounded-2xl shadow-md p-6 mb-3 border-2 border-sky-200 {% if is_available %}hover:shadow-lg hover:border-sky-300{% endif %}">
                    <div class="text-4xl {{ icon_text_color }} transition-colors">{{ kartu.icon }}</div>
                    
                    <!-- Indikator status yang akurat -->
                    {% if is_available %}
                        <div class="mt-2 w-2 h-2 bg-green-500 rounded-full mx-auto animate-pulse" title="Tersedia sekarang"></div>
                    {% elseif kartu.aktif and not kartu.jam_terbuka %}
                        <div class="mt-2 w-2 h-2 bg-yellow-500 rounded-full mx-auto" title="Diluar jam absensi"></div>
                    {% else %}
                        <div class="mt-2 w-2 h-2 bg-gray-400 rounded-full mx-auto" title="Tidak tersedia"></div>
                    {% endif %}
                </div>
                
                <!-- Label Teks -->
                <div class="px-1">
                    <p class="text-sm font-semibold {{ label_text_color }} leading-tight mb-1">{{ kartu.nama }}</p>
                    <p class="text-xs text-gray-500">{{ kartu.waktu }}</p>
                    
                    <!-- Informasi status yang jelas -->
                    {% if is_available %}
                        {% if kartu.perlu_qr %}
                            <p class="text-xs text-green-600 mt-1">📱 Scan QR</p>
                        {% else %}
                            <p class="text-xs text-green-600 mt-1">📷 Mulai Absensi</p>
                        {% endif %}
                    {% elseif kartu.aktif and not kartu.jam_terbuka %}
                        <p class="text-xs text-yellow-600 mt-1">⏰ Diluar Jam</p>
                    {% else %}
                        <p class="text-xs text-gray-400 mt-1">❌ Tidak Aktif</p>
                    {% endif %}
                </div>
                
            <!-- Penutup tag sesuai kondisi -->
            {% if is_available %}
                </a>
            {% else %}
                </div>
            {% endif %}
        </div>
        {% else %}
        <!-- Tidak Ada Kategori -->
        <div class="col-span-full">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
                <div class="text-6xl mb-4">📋</div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Tidak Ada Absensi Hari Ini</h3>
                <p class="text-gray-500 text-sm">Tidak ada jadwal absensi yang tersedia untuk hari {{ hari_ini }}.</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Menu Tambahan -->
    <div class="mt-6 grid grid-cols-2 gap-4">
        <a href="{{ path('app_profile_view') }}" class="bg-white rounded-lg shadow-sm p-4 text-center hover:bg-gray-50 transition-colors">
            <div class="text-2xl mb-2">👤</div>
            <div class="text-sm font-medium">Profil Saya</div>
        </a>
        <a href="{{ path('app_profile_change_password') }}" class="bg-white rounded-lg shadow-sm p-4 text-center hover:bg-gray-50 transition-colors">
            <div class="text-2xl mb-2">🔐</div>
            <div class="text-sm font-medium">Ganti Password</div>
        </a>
    </div>
</div>
</div>

<!-- Bottom Navigation -->
{% include 'components/bottom_nav.html.twig' with {'active_menu': 'home'} %}

<script>
// Update jam real-time dengan timezone WITA untuk jam besar di konten
function updateJam() {
    const sekarang = new Date();
    const jam = sekarang.getHours().toString().padStart(2, '0');
    const menit = sekarang.getMinutes().toString().padStart(2, '0');
    const detik = sekarang.getSeconds().toString().padStart(2, '0');

    const jamElement = document.getElementById('jam-sekarang');
    if (jamElement) jamElement.textContent = `${jam}:${menit}:${detik}`;
}

// Update setiap detik
setInterval(updateJam, 1000);
updateJam(); // Jalankan segera

// Update ranking data secara periodik (setiap 5 menit)
function updateRankingData() {
    try {
        fetch('{{ path('app_api_ranking_update') }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateRankingDisplay(data);
                } else {
                    console.warn('Gagal update ranking:', data.message);
                }
            })
            .catch(error => {
                console.warn('Error update ranking:', error);
            });
    } catch (error) {
        console.error('Error in updateRankingData:', error);
    }
}

// Function untuk update tampilan ranking
function updateRankingDisplay(data) {
    try {
        const rankingPribadi = data.ranking_pribadi;
        const rankingGroup = data.ranking_group;
        const top10 = data.top_10_pegawai;

        // Update ranking pribadi jika ada element
        const rankingPribadiElement = document.querySelector('[data-ranking-pribadi]');
        if (rankingPribadiElement && rankingPribadi.posisi > 0) {
            rankingPribadiElement.innerHTML = `🏅 Ranking Anda: #${rankingPribadi.posisi} dari ${rankingPribadi.total_pegawai} (${rankingPribadi.persentase}%) ${rankingPribadi.status}`;
        }

        // Update ranking group jika ada element - PERBAIKAN FORMAT SESUAI PERMINTAAN USER
        const rankingGroupElement = document.querySelector('[data-ranking-group]');
        if (rankingGroupElement && rankingGroup.posisi > 0) {
            rankingGroupElement.innerHTML = `Bagian ${rankingGroup.nama_unit}: #${rankingGroup.posisi} dari ${rankingGroup.total_pegawai} Pegawai`;
        }

        // Update top 10 jika ada element - PERBAIKAN FORMAT TABEL SESUAI PERMINTAAN USER
        const top10Element = document.querySelector('[data-top-10]');
        if (top10Element && top10.length > 0) {
            let top10Html = '';
            top10.forEach((pegawai, index) => {
                const isTop3 = index < 3;
                const rowClass = isTop3 ? 'font-semibold bg-yellow-100' : '';
                const borderClass = index > 0 ? 'border-t border-yellow-100' : '';

                top10Html += `
                    <tr class="${rowClass} ${borderClass}">
                        <td class="py-1 px-1 text-center">${index + 1}.</td>
                        <td class="py-1 px-1">${pegawai.nama}</td>
                        <td class="py-1 px-1 text-xs">${pegawai.unit_kerja || 'Unit Tidak Diketahui'}</td>
                        <td class="py-1 px-1 text-center font-medium">${pegawai.persentase}%</td>
                        <td class="py-1 px-1 text-center">${pegawai.status}</td>
                    </tr>
                `;
            });
            top10Element.innerHTML = top10Html;
        }
    } catch (error) {
        console.error('Error updating ranking display:', error);
    }
}

// Update ranking setiap 5 menit
setInterval(updateRankingData, 5 * 60 * 1000);

// Banner slider is now handled by the slider_carousel component

// Optimisasi untuk touch
document.addEventListener('DOMContentLoaded', function() {
    // Tambah feedback sentuh untuk semua tombol
    const buttons = document.querySelectorAll('button, a');
    buttons.forEach(button => {
        button.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.98)';
        });
        button.addEventListener('touchend', function() {
            this.style.transform = 'scale(1)';
        });
    });
});
</script>

<style>
/* Optimisasi Mobile Touch */
.touch-manipulation {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

/* Aksesbilitas button yang lebih baik */
button:focus-visible, a:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

/* Transisi halus untuk mobile */
* {
    -webkit-transition: all 0.2s ease;
    transition: all 0.2s ease;
}

/* Prevent zoom saat focus input (iOS Safari) */
input[type="text"], input[type="password"] {
    font-size: 16px;
}

/* Shadow card yang lebih baik untuk mobile */
@media (max-width: 768px) {
    .shadow-sm {
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
}
</style>
{% endblock %}