{% extends 'base.html.twig' %}

{% block title %}Profil Saya - Gembira{% endblock %}

{% block body %}
<!-- Header -->
<div class="bg-gradient-to-r from-sky-400 to-sky-500 text-white sticky top-0 z-40 shadow-lg">
    <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <a href="{{ path('app_dashboard') }}" class="text-white hover:text-sky-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <div>
                    <h1 class="text-lg font-bold">👤 Profil Saya</h1>
                    <p class="text-sky-100 text-xs">Kelola informasi pribadi Anda</p>
                </div>
            </div>

            <!-- User Info -->
            <div class="text-right">
                <div class="font-medium text-sm">{{ pegawai.nama }}</div>
                <div class="text-xs text-sky-100">{{ pegawai.nip }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="bg-gradient-to-b from-sky-50 to-sky-100 min-h-screen pb-20">
    <div class="container mx-auto px-4 py-6">

        <!-- Alert Container -->
        <div id="alertContainer" class="mb-4 hidden">
            <div id="alertMessage" class="p-4 rounded-lg shadow-sm border"></div>
        </div>

        <!-- Profil Card -->
        <div class="bg-white rounded-xl shadow-sm border border-sky-200 overflow-hidden">
            <!-- Header Card -->
            <div class="bg-gradient-to-r from-sky-500 to-sky-600 px-6 py-4">
                <div class="flex items-center space-x-4">
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <div class="text-2xl">👤</div>
                    </div>
                    <div class="text-white">
                        <h2 class="text-xl font-bold">{{ pegawai.nama }}</h2>
                        <p class="text-sky-100 text-sm">{{ pegawai.jabatan }}</p>
                    </div>
                </div>
            </div>

            <!-- Content Card -->
            <div class="p-6">
                <!-- Data Profil (Read-only) -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">📋</span>
                        Data Pegawai
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- NIP -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <label class="block text-sm font-medium text-gray-600 mb-1">NIP</label>
                            <div class="text-gray-900 font-mono">{{ pegawai.nip }}</div>
                        </div>

                        <!-- Nama Lengkap -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Nama Lengkap</label>
                            <div class="text-gray-900">{{ pegawai.nama }}</div>
                        </div>

                        <!-- Unit Kerja -->
                        <div class="bg-gray-50 rounded-lg p-4 md:col-span-2">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Unit Kerja</label>
                            <div class="text-gray-900">
                                {% if pegawai.unitKerjaEntity %}
                                    {{ pegawai.unitKerjaEntity.namaUnit }}
                                {% elseif pegawai.unitKerja %}
                                    {{ pegawai.unitKerja }}
                                {% else %}
                                    <span class="text-gray-400 italic">Tidak ada unit kerja</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data yang Bisa Diedit -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">✏️</span>
                        Informasi Kontak
                        <span class="ml-2 text-sm text-gray-500 font-normal">(Dapat diedit)</span>
                    </h3>

                    <form id="profileForm" class="space-y-4">
                        <!-- Email -->
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                Email <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                value="{{ pegawai.email }}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors text-base"
                                placeholder="nama@email.com"
                                required
                            >
                        </div>

                        <!-- Nomor Telepon -->
                        <div>
                            <label for="nomor_telepon" class="block text-sm font-medium text-gray-700 mb-2">
                                Nomor Telepon
                            </label>
                            <input
                                type="tel"
                                id="nomor_telepon"
                                name="nomor_telepon"
                                value="{{ pegawai.nomorTelepon }}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors text-base"
                                placeholder="081234567890"
                            >
                            <p class="text-sm text-gray-500 mt-1">Format: 081234567890 atau +62812345678</p>
                        </div>

                        <!-- Tombol Update -->
                        <div class="pt-4">
                            <button
                                type="submit"
                                id="submitBtn"
                                class="w-full bg-sky-600 hover:bg-sky-700 text-white font-medium py-3 px-6 rounded-lg transition-colors focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 text-base"
                            >
                                <span id="submitText">💾 Simpan Perubahan</span>
                                <span id="loadingText" class="hidden">⏳ Menyimpan...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Info Tambahan -->
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start space-x-3">
                <div class="text-blue-500 text-lg mt-0.5">💡</div>
                <div class="text-blue-800 text-sm">
                    <p class="font-medium mb-1">Informasi Penting:</p>
                    <ul class="list-disc list-inside space-y-1 text-blue-700">
                        <li>Hanya email dan nomor telepon yang dapat diubah</li>
                        <li>Email akan digunakan untuk notifikasi sistem</li>
                        <li>Pastikan nomor telepon aktif untuk komunikasi darurat</li>
                        <li>Data lain dikelola oleh administrator</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bottom Navigation -->
<div class="fixed bottom-0 left-0 right-0 bg-sky-400 shadow-2xl border-t border-sky-500 z-50">
    <div class="grid grid-cols-5 text-center">
        <!-- Home -->
        <a href="{{ path('app_dashboard') }}" class="flex flex-col items-center py-3 px-2 text-gray-200 hover:text-white hover:bg-sky-500 transition-colors rounded-lg mx-1">
            <div class="text-lg mb-1">🏠</div>
            <div class="text-xs">Home</div>
        </a>

        <!-- Laporan -->
        <a href="{{ path('app_user_laporan') }}" class="flex flex-col items-center py-3 px-2 text-gray-200 hover:text-white hover:bg-sky-500 transition-colors rounded-lg mx-1">
            <div class="text-lg mb-1">📊</div>
            <div class="text-xs">Laporan</div>
        </a>

        <!-- Kalender -->
        <a href="{{ path('app_user_kalender') }}" class="flex flex-col items-center py-3 px-2 text-gray-200 hover:text-white hover:bg-sky-500 transition-colors rounded-lg mx-1">
            <div class="text-lg mb-1">📅</div>
            <div class="text-xs">Kalender</div>
        </a>

        <!-- Notifikasi -->
        <a href="#" class="flex flex-col items-center py-3 px-2 text-gray-200 hover:text-white hover:bg-sky-500 transition-colors rounded-lg mx-1">
            <div class="text-lg mb-1">🔔</div>
            <div class="text-xs">Notifikasi</div>
        </a>

        <!-- Profil - Active -->
        <a href="{{ path('app_profile_view') }}" class="flex flex-col items-center py-3 px-2 text-white bg-sky-600 rounded-lg mx-1">
            <div class="text-lg mb-1">👤</div>
            <div class="text-xs font-medium">Profil</div>
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('profileForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingText = document.getElementById('loadingText');
    const alertContainer = document.getElementById('alertContainer');
    const alertMessage = document.getElementById('alertMessage');

    // Handle form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Disable button dan show loading
        submitBtn.disabled = true;
        submitText.classList.add('hidden');
        loadingText.classList.remove('hidden');

        // Get form data
        const formData = new FormData(form);

        try {
            const response = await fetch('{{ path('app_profile_edit') }}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                showAlert(result.message, 'success');

                // Update form values dengan data terbaru
                if (result.data) {
                    document.getElementById('email').value = result.data.email || '';
                    document.getElementById('nomor_telepon').value = result.data.nomor_telepon || '';
                }
            } else {
                showAlert(result.message, 'error');
            }

        } catch (error) {
            console.error('Error:', error);
            showAlert('❌ Terjadi kesalahan koneksi. Silakan coba lagi.', 'error');
        } finally {
            // Reset button
            submitBtn.disabled = false;
            submitText.classList.remove('hidden');
            loadingText.classList.add('hidden');
        }
    });

    // Function to show alert
    function showAlert(message, type) {
        alertContainer.classList.remove('hidden');
        alertMessage.textContent = message;

        // Remove previous alert classes
        alertMessage.classList.remove('bg-green-100', 'border-green-500', 'text-green-700');
        alertMessage.classList.remove('bg-red-100', 'border-red-500', 'text-red-700');

        if (type === 'success') {
            alertMessage.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
        } else {
            alertMessage.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
        }

        // Auto hide after 5 seconds
        setTimeout(() => {
            alertContainer.classList.add('hidden');
        }, 5000);

        // Scroll to top to show alert
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Phone number input formatting
    const phoneInput = document.getElementById('nomor_telepon');
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value;
        // Remove non-numeric characters except +, -, space, and parentheses
        value = value.replace(/[^0-9+\-\s\(\)]/g, '');
        e.target.value = value;
    });
});

// Mobile touch optimization
document.addEventListener('DOMContentLoaded', function() {
    // Add touch feedback for buttons
    const buttons = document.querySelectorAll('button, a');
    buttons.forEach(button => {
        button.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.98)';
        });
        button.addEventListener('touchend', function() {
            this.style.transform = 'scale(1)';
        });
    });
});
</script>

<style>
/* Mobile-first responsive design */
@media (max-width: 640px) {
    .container {
        padding-left: 1rem;
        padding-right: 1rem;
    }

    .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
    }
}

/* Ensure touch targets are large enough */
input, button {
    min-height: 48px;
}

/* Better focus states for accessibility */
input:focus, button:focus {
    outline: 2px solid #0ea5e9;
    outline-offset: 2px;
}

/* Smooth transitions */
* {
    transition: all 0.2s ease;
}

/* Prevent zoom on iOS Safari when focusing inputs */
input[type="email"], input[type="tel"] {
    font-size: 16px;
}
</style>
{% endblock %}